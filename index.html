# app.py
# PROFESSIONAL INVESTMENT ANALYTICS PLATFORM (SINGLE FILE)

from fastapi import FastAPI, WebSocket
from fastapi.middleware.cors import CORSMiddleware
import yfinance as yf
import pandas as pd
import asyncio
from sklearn.linear_model import LinearRegression
import numpy as np

app = FastAPI(title="Professional Investment Analytics Engine")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# =========================
# REAL STOCK / ETF / BOND DATA
# =========================
@app.get("/market/{symbol}")
def get_market_data(symbol: str):
    ticker = yf.Ticker(symbol)
    hist = ticker.history(period="1d", interval="1m")
    info = ticker.info

    if hist.empty:
        return {"error": "Symbol not found"}

    return {
        "symbol": symbol,
        "price": float(hist["Close"][-1]),
        "open": float(hist["Open"][-1]),
        "high": float(hist["High"][-1]),
        "low": float(hist["Low"][-1]),
        "volume": int(hist["Volume"][-1]),
        "marketCap": info.get("marketCap"),
        "peRatio": info.get("trailingPE"),
        "eps": info.get("trailingEps"),
        "debtToEquity": info.get("debtToEquity"),
        "sector": info.get("sector"),
        "industry": info.get("industry"),
        "currency": info.get("currency"),
    }

# =========================
# TECHNICAL ANALYSIS
# =========================
@app.get("/technical/{symbol}")
def technical_analysis(symbol: str):
    df = yf.download(symbol, period="6mo")
    df["MA20"] = df["Close"].rolling(20).mean()
    df["MA50"] = df["Close"].rolling(50).mean()

    delta = df["Close"].diff()
    gain = (delta.where(delta > 0, 0)).rolling(14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
    rs = gain / loss
    df["RSI"] = 100 - (100 / (1 + rs))

    return {
        "MA20": float(df["MA20"][-1]),
        "MA50": float(df["MA50"][-1]),
        "RSI": float(df["RSI"][-1]),
    }

# =========================
# ETF / OBLIGATION ANALYSIS
# =========================
@app.get("/fund/{symbol}")
def fund_analysis(symbol: str):
    fund = yf.Ticker(symbol)
    info = fund.info

    return {
        "expenseRatio": info.get("expenseRatio"),
        "yield": info.get("yield"),
        "fundFamily": info.get("fundFamily"),
        "category": info.get("category"),
        "totalAssets": info.get("totalAssets"),
    }

# =========================
# AI PRICE FORECAST (ML)
# =========================
@app.get("/ai/forecast/{symbol}")
def ai_forecast(symbol: str):
    df = yf.download(symbol, period="1y")
    df = df.reset_index()

    df["day"] = np.arange(len(df))
    X = df[["day"]]
    y = df["Close"]

    model = LinearRegression()
    model.fit(X, y)

    future_day = np.array([[len(df) + 7]])
    prediction = model.predict(future_day)

    return {
        "symbol": symbol,
        "forecast_7_days": float(prediction[0]),
        "model": "Linear Regression",
    }

# =========================
# RISK SCORE ENGINE
# =========================
@app.get("/risk/{symbol}")
def risk_score(symbol: str):
    df = yf.download(symbol, period="6mo")
    volatility = df["Close"].pct_change().std()

    risk = "LOW"
    if volatility > 0.03:
        risk = "HIGH"
    elif volatility > 0.015:
        risk = "MEDIUM"

    return {
        "symbol": symbol,
        "volatility": float(volatility),
        "riskLevel": risk,
    }

# =========================
# REAL-TIME WEBSOCKET STREAM
# =========================
@app.websocket("/ws/{symbol}")
async def realtime_price(ws: WebSocket, symbol: str):
    await ws.accept()
    while True:
        ticker = yf.Ticker(symbol)
        hist = ticker.history(period="1d", interval="1m")
        if not hist.empty:
            price = float(hist["Close"][-1])
            await ws.send_json({"symbol": symbol, "price": price})
        await asyncio.sleep(5)

# =========================
# PLATFORM STATUS
# =========================
@app.get("/")
def root():
    return {
        "status": "ACTIVE",
        "platform": "Professional Investment Analytics",
        "features": [
            "Real-time prices",
            "Stocks / ETFs / Bonds",
            "Technical Analysis",
            "AI Forecast",
            "Risk Engine",
            "WebSocket Live Data",
        ],
    }
